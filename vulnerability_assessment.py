#!/usr/bin/env python3

"""
Comprehensive Vulnerability Assessment Framework
This script demonstrates how to conduct a full vulnerability assessment
using the Kali MCP server with all authorized tools.

Author: Security Assessment Team
Purpose: Educational and defensive security research only
"""

import json
import time
import argparse
from datetime import datetime
from pathlib import Path
from typing import Dict, Any, List
import sys
import os

# Add the current directory to the path to import our MCP client
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

try:
    from mcp_server import KaliToolsClient, setup_mcp_server
except ImportError:
    print("Error: Could not import MCP server. Ensure mcp_server.py is in the same directory.")
    sys.exit(1)

class VulnerabilityAssessment:
    """
    Comprehensive vulnerability assessment framework
    """
    
    def __init__(self, target: str, output_dir: str = "assessment_results"):
        """
        Initialize the assessment
        
        Args:
            target: Target system (IP, hostname, or domain)
            output_dir: Directory to store results
        """
        self.target = target
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(exist_ok=True)
        
        # Create subdirectories
        (self.output_dir / "scans").mkdir(exist_ok=True)
        (self.output_dir / "logs").mkdir(exist_ok=True)
        (self.output_dir / "reports").mkdir(exist_ok=True)
        
        # Initialize MCP client
        self.kali_client = KaliToolsClient("http://localhost:5000")
        self.mcp = setup_mcp_server(self.kali_client)
        
        # Assessment log
        self.assessment_log = []
        
        print(f"[*] Vulnerability Assessment initialized for target: {target}")
        print(f"[*] Results will be stored in: {self.output_dir}")
    
    def log_result(self, category: str, tool: str, result: Dict[str, Any], success: bool = True):
        """
        Log assessment results
        
        Args:
            category: Assessment category
            tool: Tool used
            result: Tool execution result
            success: Whether the tool execution was successful
        """
        timestamp = datetime.now().isoformat()
        log_entry = {
            "timestamp": timestamp,
            "category": category,
            "tool": tool,
            "success": success,
            "target": self.target
        }
        
        if success:
            # Save detailed results
            result_file = self.output_dir / "scans" / f"{category}_{tool}_{timestamp.replace(':', '-')}.json"
            with open(result_file, 'w') as f:
                json.dump(result, f, indent=2)
            log_entry["result_file"] = str(result_file)
        else:
            log_entry["error"] = result.get("error", "Unknown error")
        
        self.assessment_log.append(log_entry)
        
        # Update console
        status = "✓" if success else "✗"
        print(f"[{timestamp}] {status} {category}/{tool}")
    
    def phase1_system_information(self):
        """
        Phase 1: System Information Gathering
        """
        print("\n" + "="*60)
        print("PHASE 1: SYSTEM INFORMATION GATHERING")
        print("="*60)
        
        # Comprehensive system info
        try:
            result = self.mcp.system_info_gather("all")
            self.log_result("system_info", "system_info", result, result.get("success", False))
        except Exception as e:
            self.log_result("system_info", "system_info", {"error": str(e)}, False)
        
        time.sleep(2)  # Brief pause between scans
    
    def phase2_network_scanning(self):
        """
        Phase 2: Network, Port & Service Scanning
        """
        print("\n" + "="*60)
        print("PHASE 2: NETWORK, PORT & SERVICE SCANNING")
        print("="*60)
        
        # Nmap comprehensive scan
        try:
            result = self.mcp.nmap_scan(self.target, "-sCV", "", "-T4 -Pn")
            self.log_result("network", "nmap", result, result.get("success", False))
        except Exception as e:
            self.log_result("network", "nmap", {"error": str(e)}, False)
        
        # Masscan fast port scan
        try:
            result = self.mcp.masscan_scan(self.target, "1-1000", "1000")
            self.log_result("network", "masscan", result, result.get("success", False))
        except Exception as e:
            self.log_result("network", "masscan", {"error": str(e)}, False)
        
        # RustScan
        try:
            result = self.mcp.rustscan_scan(self.target, "-")
            self.log_result("network", "rustscan", result, result.get("success", False))
        except Exception as e:
            self.log_result("network", "rustscan", {"error": str(e)}, False)
        
        time.sleep(3)
    
    def phase3_os_vulnerability_scanning(self):
        """
        Phase 3: Operating System & Package Vulnerability Scanning
        """
        print("\n" + "="*60)
        print("PHASE 3: OS VULNERABILITY SCANNING")
        print("="*60)
        
        # Lynis system audit
        try:
            result = self.mcp.lynis_audit("audit system")
            self.log_result("os_vuln", "lynis", result, result.get("success", False))
        except Exception as e:
            self.log_result("os_vuln", "lynis", {"error": str(e)}, False)
        
        # Debsecan (for Debian-based systems)
        try:
            result = self.mcp.debsecan_scan("--suite stable")
            self.log_result("os_vuln", "debsecan", result, result.get("success", False))
        except Exception as e:
            self.log_result("os_vuln", "debsecan", {"error": str(e)}, False)
        
        time.sleep(3)
    
    def phase4_web_application_scanning(self):
        """
        Phase 4: Web Server & Web Application Scanning
        """
        print("\n" + "="*60)
        print("PHASE 4: WEB APPLICATION SCANNING")
        print("="*60)
        
        # Only run if target appears to be a web service
        web_target = f"http://{self.target}" if not self.target.startswith(('http://', 'https://')) else self.target
        
        # WhatWeb technology identification
        try:
            result = self.mcp.whatweb_scan(web_target)
            self.log_result("web_app", "whatweb", result, result.get("success", False))
        except Exception as e:
            self.log_result("web_app", "whatweb", {"error": str(e)}, False)
        
        # Nikto web server scanner
        try:
            result = self.mcp.nikto_scan(web_target)
            self.log_result("web_app", "nikto", result, result.get("success", False))
        except Exception as e:
            self.log_result("web_app", "nikto", {"error": str(e)}, False)
        
        # Wapiti web application scanner
        try:
            result = self.mcp.wapiti_scan(web_target, "domain")
            self.log_result("web_app", "wapiti", result, result.get("success", False))
        except Exception as e:
            self.log_result("web_app", "wapiti", {"error": str(e)}, False)
        
        # SSL/TLS scanning (if applicable)
        try:
            result = self.mcp.sslyze_scan(web_target)
            self.log_result("web_app", "sslyze", result, result.get("success", False))
        except Exception as e:
            self.log_result("web_app", "sslyze", {"error": str(e)}, False)
        
        try:
            result = self.mcp.testssl_scan(web_target)
            self.log_result("web_app", "testssl", result, result.get("success", False))
        except Exception as e:
            self.log_result("web_app", "testssl", {"error": str(e)}, False)
        
        time.sleep(3)
    
    def phase5_configuration_compliance(self):
        """
        Phase 5: Configuration, Compliance & Hardening Analysis
        """
        print("\n" + "="*60)
        print("PHASE 5: CONFIGURATION COMPLIANCE")
        print("="*60)
        
        # OpenSCAP compliance scan
        try:
            result = self.mcp.openscap_scan()
            self.log_result("compliance", "openscap", result, result.get("success", False))
        except Exception as e:
            self.log_result("compliance", "openscap", {"error": str(e)}, False)
        
        # Osquery system queries
        queries = [
            "SELECT * FROM listening_ports;",
            "SELECT * FROM processes WHERE name LIKE '%ssh%';",
            "SELECT * FROM users WHERE uid >= 1000;",
            "SELECT * FROM cron;"
        ]
        
        for i, query in enumerate(queries):
            try:
                result = self.mcp.osquery_query(query)
                self.log_result("compliance", f"osquery_{i+1}", result, result.get("success", False))
            except Exception as e:
                self.log_result("compliance", f"osquery_{i+1}", {"error": str(e)}, False)
        
        time.sleep(2)
    
    def phase6_malware_rootkit_detection(self):
        """
        Phase 6: File Integrity, Rootkit & Malware Detection
        """
        print("\n" + "="*60)
        print("PHASE 6: MALWARE & ROOTKIT DETECTION")
        print("="*60)
        
        # RKHunter
        try:
            result = self.mcp.rkhunter_scan("--checkall")
            self.log_result("malware", "rkhunter", result, result.get("success", False))
        except Exception as e:
            self.log_result("malware", "rkhunter", {"error": str(e)}, False)
        
        # Chkrootkit
        try:
            result = self.mcp.chkrootkit_scan()
            self.log_result("malware", "chkrootkit", result, result.get("success", False))
        except Exception as e:
            self.log_result("malware", "chkrootkit", {"error": str(e)}, False)
        
        # AIDE integrity check
        try:
            result = self.mcp.aide_scan("--check")
            self.log_result("malware", "aide", result, result.get("success", False))
        except Exception as e:
            self.log_result("malware", "aide", {"error": str(e)}, False)
        
        # ClamAV scan
        try:
            result = self.mcp.clamav_scan("/", "--infected")
            self.log_result("malware", "clamav", result, result.get("success", False))
        except Exception as e:
            self.log_result("malware", "clamav", {"error": str(e)}, False)
        
        time.sleep(3)
    
    def phase7_container_cloud_security(self):
        """
        Phase 7: Container & Cloud Security Assessment
        """
        print("\n" + "="*60)
        print("PHASE 7: CONTAINER & CLOUD SECURITY")
        print("="*60)
        
        # Docker Bench Security
        try:
            result = self.mcp.docker_bench_scan()
            self.log_result("container", "docker_bench", result, result.get("success", False))
        except Exception as e:
            self.log_result("container", "docker_bench", {"error": str(e)}, False)
        
        # Trivy vulnerability scanner
        try:
            result = self.mcp.trivy_scan(".", "fs")
            self.log_result("container", "trivy", result, result.get("success", False))
        except Exception as e:
            self.log_result("container", "trivy", {"error": str(e)}, False)
        
        # Grype vulnerability scanner
        try:
            result = self.mcp.grype_scan(".")
            self.log_result("container", "grype", result, result.get("success", False))
        except Exception as e:
            self.log_result("container", "grype", {"error": str(e)}, False)
        
        time.sleep(2)
    
    def phase8_database_security(self):
        """
        Phase 8: Database Security Assessment
        """
        print("\n" + "="*60)
        print("PHASE 8: DATABASE SECURITY")
        print("="*60)
        
        # MySQLTuner
        try:
            result = self.mcp.mysqltuner_scan()
            self.log_result("database", "mysqltuner", result, result.get("success", False))
        except Exception as e:
            self.log_result("database", "mysqltuner", {"error": str(e)}, False)
        
        time.sleep(2)
    
    def phase9_network_traffic_analysis(self):
        """
        Phase 9: Network Traffic & Protocol Analysis
        """
        print("\n" + "="*60)
        print("PHASE 9: NETWORK TRAFFIC ANALYSIS")
        print("="*60)
        
        # Tcpdump capture (limited packets)
        try:
            result = self.mcp.tcpdump_capture("eth0", "", "50")
            self.log_result("network_analysis", "tcpdump", result, result.get("success", False))
        except Exception as e:
            self.log_result("network_analysis", "tcpdump", {"error": str(e)}, False)
        
        # Tshark analysis (limited packets)
        try:
            result = self.mcp.tshark_analyze("eth0", "", "50")
            self.log_result("network_analysis", "tshark", result, result.get("success", False))
        except Exception as e:
            self.log_result("network_analysis", "tshark", {"error": str(e)}, False)
        
        time.sleep(2)
    
    def phase10_osint_reconnaissance(self):
        """
        Phase 10: OSINT & Passive Reconnaissance
        """
        print("\n" + "="*60)
        print("PHASE 10: OSINT & PASSIVE RECONNAISSANCE")
        print("="*60)
        
        # TheHarvester (for domains)
        if '.' in self.target and not self.target.replace('.', '').isdigit():
            try:
                result = self.mcp.theharvester_osint(self.target, "baidu,google", "100")
                self.log_result("osint", "theharvester", result, result.get("success", False))
            except Exception as e:
                self.log_result("osint", "theharvester", {"error": str(e)}, False)
        
        # Recon-ng passive modules
        try:
            result = self.mcp.recon_ng_passive("default", [])
            self.log_result("osint", "recon_ng", result, result.get("success", False))
        except Exception as e:
            self.log_result("osint", "recon_ng", {"error": str(e)}, False)
        
        time.sleep(2)
    
    def phase11_authentication_analysis(self):
        """
        Phase 11: Password Policy & Authentication Analysis
        """
        print("\n" + "="*60)
        print("PHASE 11: AUTHENTICATION ANALYSIS")
        print("="*60)
        
        # Cracklib-check example
        try:
            result = self.mcp.cracklib_check_password("TestPassword123!")
            self.log_result("auth", "cracklib_check", result, result.get("success", False))
        except Exception as e:
            self.log_result("auth", "cracklib_check", {"error": str(e)}, False)
        
        # John the Ripper hash policy audit
        try:
            result = self.mcp.john_hash_audit("/etc/shadow", "--test")
            self.log_result("auth", "john_audit", result, result.get("success", False))
        except Exception as e:
            self.log_result("auth", "john_audit", {"error": str(e)}, False)
        
        time.sleep(2)
    
    def phase12_metasploit_auxiliary(self):
        """
        Phase 12: Metasploit Auxiliary Modules (Recon & Enumeration Only)
        """
        print("\n" + "="*60)
        print("PHASE 12: METASPLOIT AUXILIARY MODULES")
        print("="*60)
        
        # Example auxiliary modules for reconnaissance
        auxiliary_modules = [
            "auxiliary/scanner/portscan/tcp",
            "auxiliary/scanner/smb/smb_version",
            "auxiliary/scanner/ssh/ssh_version"
        ]
        
        for module in auxiliary_modules:
            try:
                options = {"RHOSTS": self.target}
                result = self.mcp.metasploit_auxiliary(module, options)
                self.log_result("metasploit", module.replace("/", "_"), result, result.get("success", False))
            except Exception as e:
                self.log_result("metasploit", module.replace("/", "_"), {"error": str(e)}, False)
        
        time.sleep(3)
    
    def phase13_log_analysis(self):
        """
        Phase 13: Log Analysis & Monitoring
        """
        print("\n" + "="*60)
        print("PHASE 13: LOG ANALYSIS")
        print("="*60)
        
        # Logwatch analysis
        try:
            result = self.mcp.logwatch_analysis("all", "yesterday", "med")
            self.log_result("logs", "logwatch", result, result.get("success", False))
        except Exception as e:
            self.log_result("logs", "logwatch", {"error": str(e)}, False)
        
        time.sleep(2)
    
    def phase14_Infrastructure_as_Code(self):
        """
        Phase 14: Infrastructure as Code Security
        """
        print("\n" + "="*60)
        print("PHASE 14: INFRASTRUCTURE AS CODE SECURITY")
        print("="*60)
        
        # Checkov IaC scanning
        try:
            result = self.mcp.checkov_scan(".", "all")
            self.log_result("iac", "checkov", result, result.get("success", False))
        except Exception as e:
            self.log_result("iac", "checkov", {"error": str(e)}, False)
        
        time.sleep(2)
    
    def generate_report(self):
        """
        Generate comprehensive assessment report
        """
        print("\n" + "="*60)
        print("GENERATING COMPREHENSIVE REPORT")
        print("="*60)
        
        report = {
            "assessment_metadata": {
                "target": self.target,
                "start_time": self.assessment_log[0]["timestamp"] if self.assessment_log else None,
                "end_time": datetime.now().isoformat(),
                "total_tools_executed": len(self.assessment_log),
                "successful_scans": len([log for log in self.assessment_log if log["success"]]),
                "failed_scans": len([log for log in self.assessment_log if not log["success"]])
            },
            "assessment_log": self.assessment_log,
            "summary": {
                "categories": {},
                "tools_used": list(set([log["tool"] for log in self.assessment_log])),
                "findings": []
            }
        }
        
        # Generate category summary
        for log in self.assessment_log:
            category = log["category"]
            if category not in report["summary"]["categories"]:
                report["summary"]["categories"][category] = {"total": 0, "successful": 0, "failed": 0}
            
            report["summary"]["categories"][category]["total"] += 1
            if log["success"]:
                report["summary"]["categories"][category]["successful"] += 1
            else:
                report["summary"]["categories"][category]["failed"] += 1
        
        # Save report
        report_file = self.output_dir / "reports" / f"vulnerability_assessment_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(report_file, 'w') as f:
            json.dump(report, f, indent=2)
        
        # Save assessment log
        log_file = self.output_dir / "logs" / f"assessment_log_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(log_file, 'w') as f:
            json.dump(self.assessment_log, f, indent=2)
        
        print(f"\n[*] Assessment completed!")
        print(f"[*] Total tools executed: {report['assessment_metadata']['total_tools_executed']}")
        print(f"[*] Successful scans: {report['assessment_metadata']['successful_scans']}")
        print(f"[*] Failed scans: {report['assessment_metadata']['failed_scans']}")
        print(f"[*] Report saved to: {report_file}")
        print(f"[*] Log saved to: {log_file}")
        
        return report_file
    
    def run_full_assessment(self):
        """
        Execute the complete vulnerability assessment
        """
        print("="*80)
        print("COMPREHENSIVE VULNERABILITY ASSESSMENT")
        print("="*80)
        print(f"Target: {self.target}")
        print(f"Output Directory: {self.output_dir}")
        print("="*80)
        
        try:
            # Check server health first
            health = self.kali_client.check_health()
            if "error" in health:
                print(f"[!] Error connecting to Kali API server: {health['error']}")
                return None
            
            print(f"[*] Connected to Kali API server")
            print(f"[*] Server health: {health.get('status', 'unknown')}")
            
            # Run all assessment phases
            phases = [
                self.phase1_system_information,
                self.phase2_network_scanning,
                self.phase3_os_vulnerability_scanning,
                self.phase4_web_application_scanning,
                self.phase5_configuration_compliance,
                self.phase6_malware_rootkit_detection,
                self.phase7_container_cloud_security,
                self.phase8_database_security,
                self.phase9_network_traffic_analysis,
                self.phase10_osint_reconnaissance,
                self.phase11_authentication_analysis,
                self.phase12_metasploit_auxiliary,
                self.phase13_log_analysis,
                self.phase14_Infrastructure_as_Code
            ]
            
            for phase in phases:
                try:
                    phase()
                except KeyboardInterrupt:
                    print("\n[!] Assessment interrupted by user")
                    break
                except Exception as e:
                    print(f"[!] Error in phase {phase.__name__}: {str(e)}")
                    continue
            
            # Generate final report
            return self.generate_report()
            
        except KeyboardInterrupt:
            print("\n[!] Assessment interrupted by user")
            return None
        except Exception as e:
            print(f"[!] Critical error during assessment: {str(e)}")
            return None

def main():
    """
    Main entry point
    """
    parser = argparse.ArgumentParser(
        description="Comprehensive Vulnerability Assessment Framework",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  python vulnerability_assessment.py 192.168.1.100
  python vulnerability_assessment.py example.com -o custom_results
  python vulnerability_assessment.py 10.0.0.1 --phases network,web_app
        """
    )
    
    parser.add_argument("target", help="Target system (IP, hostname, or domain)")
    parser.add_argument("-o", "--output", default="assessment_results", 
                       help="Output directory for results (default: assessment_results)")
    parser.add_argument("--phases", help="Comma-separated list of phases to run (optional)")
    parser.add_argument("--debug", action="store_true", help="Enable debug output")
    
    args = parser.parse_args()
    
    print("="*80)
    print("COMPREHENSIVE VULNERABILITY ASSESSMENT FRAMEWORK")
    print("="*80)
    print("Purpose: Educational and defensive security research only")
    print("Authorized Use: Learning, research, and defensive understanding")
    print("="*80)
    
    # Initialize assessment
    assessment = VulnerabilityAssessment(args.target, args.output)
    
    # Run assessment
    if args.phases:
        print(f"[*] Running selected phases: {args.phases}")
        # TODO: Implement phase selection logic
        print("[!] Phase selection not yet implemented. Running full assessment.")
    
    report_file = assessment.run_full_assessment()
    
    if report_file:
        print(f"\n[*] Assessment completed successfully!")
        print(f"[*] View the detailed report at: {report_file}")
    else:
        print(f"\n[!] Assessment completed with errors or was interrupted")

if __name__ == "__main__":
    main()
